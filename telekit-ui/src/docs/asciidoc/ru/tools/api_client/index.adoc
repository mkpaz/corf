Утилита предназначена для автоматизации запросов к сервисам, которые предоставляют публичный API для управления. Это может быть REST API, SOAP API или другой API, который принимает HTTP(S) запросы.

Общий вид:

image::tools/api_client_main.png[]

==== Вкладка Settings

* Template - выбранный шаблон и выпадающий список с опциями управления шаблоном:
** Preview - предварительный просмотр выбранного шаблона;
** New - создание нового шаблона;
** Edit - редактирование выбранного шаблона;
** Duplicate - создание нового шаблона, в качестве начальных данных которого будут скопированы данные из выбранного шаблона;
** Delete - редактирование выбранного шаблона;
** Import - импорт нового шаблона из файла;
** Export - экспорт выбранного шаблона в файл;
* Basic Authentication - имя пользователя и пароль для https://ru.wikipedia.org/wiki/Аутентификация_в_Интернете#Базовая_аутентификация[базовой аутентификации] (опционально, если требуется со стороны API);
* Parameters - таблица параметров для замены, которые остаются постоянными при выполнении каждого отдельного запроса. Добавление и удаление параметров выполняется через контекстное меню. Типы параметров:
** CONSTANT - постоянное значение;
** PASSWORD - случайная строка заданной длины сгенерированная из символов `[a-ZA-Z0-9]`;
** PASSWORD_BASE64 - то же самое, что и предыдущий пункт, но значение будет преобразовано в BASE64 строку после генерации;
** UUID - 16-байтный https://ru.wikipedia.org/wiki/UUID[уникальный идентификатор] (например, `718b5495-4511-4064-8923-560ec2127d23`).
+
* List fo replacement - список параметров для замены. Представляет собой CSV (список значений разделенных запятыми) таблицу. В качестве разделителя элементов строки поддерживается запятая или точка с запятой;
* Clipboard - дополнительные опции для вставки из буфера обмена в список параметров для замены:
** Paste from MS Excel - вставка данных из MS Excel;
** Paste columns on the right - вставка данных с правой стороны от уже имеющихся в списке данных (табличная вставка).
* Start / Stop - кнопки запуска и остановки;
* Timeout between requests - таймаут между выполнением запросов к API в миллисекундах.

==== Вкладка Log

* Completed requests - таблица завершенных запросов к API;
* Show unsuccessful requests only - фильтр, активирующий отображение в таблице только неуспешных запросов;
* Export - экспорт всех завершенных запросов к API в текстовый файл;
* Details - детальная информация по каждому HTTP(S) запросу.

==== Использование

Для использования клиента необходимо создать шаблон описывающий формат HTTP запроса для конкретного сервиса (endpoint), предоставляемого удаленным API.

При создании шаблона поддерживаются следующие поля (* отмечены обязательные пункты):

* Name *** - уникальное имя шаблона;
* URI *** - полный адрес (URI) к которому будет осуществляться HTTP(s) запрос;
* Method *** - https://ru.wikipedia.org/wiki/HTTP#Методы[HTTP метод] запроса;
* Content type *** - https://ru.wikipedia.org/wiki/MIME[MIME тип] запроса;
* Headers - дополнительные https://ru.wikipedia.org/wiki/HTTP#Методы[HTTP заголовки] запроса;
* Body *** - полезная нагрузка (тело) запроса;
* Batch size - количество объединяемых запросов;
* Batch wrapper - выражение, описывающее каким образом формируется полезная нагрузка при объединении запросов;
* Wait timeout *** - таймаут ожидания ответа удаленной стороны в секундах. Разные запросы требуют различного времени от сервера на обработку. Данный параметр регулирует время ожидания ответа по истечении которого будет выполнен новый запрос, а текущий отмечен как неудавшийся;
* Description - описание - любая доплнительная / справочная информация к шаблону.

Как правило, все указанные параметры однозначно описываются документацией к соответствующему API. В качестве примера, рассмотрим открытый API для тестирования https://jsonplaceholder.typicode.com/guide.html[JSONPlaceholder]. Согласно документации, так выглядит создание ресурса в каталоге `/posts`.

```js
fetch('https://jsonplaceholder.typicode.com/posts', {
    method: 'POST',
    body: JSON.stringify({
      title: 'foo',
      body: 'bar',
      userId: 1
    }),
    headers: {
      "Content-type": "application/json; charset=UTF-8"
    }
  })
```

Таким образом, соответствующий шаблон:

* URI = `https://jsonplaceholder.typicode.com/posts`
* Method = POST
* Content type = `application/json`
* Headers - дополнительные HTTP заголовки не требуются
* Body
+
```json
{ title: '%(_csv0) ел кашу', body: '%(test)', userId: 1 }
```
+


Правила замены при выполнении запроса:

* формат параметров для замены имеет вид: `%(имя_параметра)`, где `имя_параметра`:
** один из встроенных параметров:
*** `_index0` - порядковый номер строки списка начиная с 0;
*** `_index1` - порядковый номер строки списка начиная с 1;
** название параметра из таблицы *Parameters*;
** идентификатор параметра из списка *List for replacement*. В этом случае, имя параметра имеет фиксированный вид `_csvX`, где X - порядковый номер начиная с 0.
* в обычном режиме замена осуществляется в полях URI, Headers и Body; в batch-режиме (batch size > 1) замена выполняется только в Body.

Возвращаясь к примеру, если список для замены имеет вид:

```
Пушкин,Александр
Есенин,Сергей
Лермонтов,Михаил
```

А в таблице параметров создан параметр `test` с типом CONSTANT, которому назначено значение `12345`, то будет выполнено три HTTPS запроса, т.е. в обычном режиме, количество выполняемых HTTP запросов равно количеству строк в списке для замены.

```
POST https://jsonplaceholder.typicode.com/posts
{ title: 'Пушкин ел кашу', body: '12345', userId: 1 }

POST https://jsonplaceholder.typicode.com/posts
{ title: 'Есенин ел кашу', body: '12345', userId: 1 }

POST https://jsonplaceholder.typicode.com/posts
{ title: 'Лермонтов ел кашу', body: '12345', userId: 1 }
```

Как видно, параметр `_csv1` был проигнорирован, поскольку соответствующее ему выражение для замены `%(_csv1)` нигде в шаблоне не фигурирует. Таким образом, одну и ту же таблицу (список для замены) можно использовать многократно в нескольких шаблонах просто выбирая в каждом из них только нужные колонки.

==== Batch-режим

В этом режиме осуществляется объединение нескольких запросов в один. Количество объединяемых запросов регулируется параметром *Batch size* в шаблоне. Также необходима поддержка такого формата запросов со стороны API.

Посмотрим на предыдущий пример, все три запроса можно объединить в один. Для этого полезная нагрузка должна иметь следующий вид:

```json
[
    { title: 'Пушкин ел кашу', body: '12345', userId: 1 },
    { title: 'Есенин ел кашу', body: '12345', userId: 1 },
    { title: 'Лермонтов ел кашу', body: '12345', userId: 1 }
]
```

Этого можно добиться дополнительно установив следующие значения параметров в шаблоне:

* *Batch size* = 5;
+
Количество объединяемых запросов может быть выбрано любым, кратным пяти. Если количество строк в списке не делится на пять без остатка, то это отразится только на последнем запросе. Например, для 12 строк будет выполнено 3 запроса (`5 + 5 + 2`).
+

* *Batch wrapper* = `[%(batch)]`;
+
Значение `%(batch)` представляет собой результат объединения нескольких элементов *Body* в один. Объединение выполняется после замены `%(xxx)` параметров, а результат вставляется на указанное место (в данном случае, между квадратных скобок).

Элементы *Body* в выражении `%(batch)` разделяются друг от друга с помощью символа разделителя, который определяется автоматически, исходя из значения параметра *Content type*:

* `application/json` - запятая;
* `application/soap+xml` - новая строка (`\n`);
* `other` - новая строка (`\n`).





